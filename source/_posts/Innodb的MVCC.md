---
title: Innodb的MVCC
date: 2024/10/15 22:20:25
categories: MySql
tags: MVCC
---



**InnoDB 的多版本控制（MVCC，Multi-Version Concurrency Control）**，它如何通过维护旧版本数据行来支持事务并发和一致性读取，并详细解释了 InnoDB 的多版本处理机制，以及如何管理回滚段和处理索引相关的操作。我们可以从以下几个方面来理解这段内容：

### 1. **多版本控制和回滚段**
InnoDB 是一个多版本存储引擎，为了支持事务回滚和一致性读取，它会在后台保存每一行数据的旧版本。旧版本数据的管理通过回滚段（rollback segment）来实现，回滚段存储在系统表空间或专门的 undo 表空间中。

- **回滚段（Rollback Segment）**：当事务对一行数据进行更新时，InnoDB 会记录旧版本数据，这些记录存储在回滚段中。事务回滚时，InnoDB 使用这些信息来撤销对数据的更改。
- **一致性读取**：当一个事务在进行读取操作时，如果读到的记录在该事务开始后被其他事务修改了，InnoDB 可以通过回滚段中的旧版本数据来构建该行在修改前的状态，从而实现一致性读取。

### 2. **行的隐藏字段**
每一行数据在 InnoDB 中存储时，会增加三个隐藏字段，用来支持多版本控制：
- **`DB_TRX_ID`（事务 ID）**：6 字节长，记录最后一次插入或更新该行数据的事务 ID。如果是删除操作，InnoDB 会将其标记为删除，但实质上和更新类似。
- **`DB_ROLL_PTR`（回滚指针）**：7 字节长，指向回滚段中的 undo 日志记录，用于追踪该行更新前的旧版本信息。
- **`DB_ROW_ID`（行 ID）**：6 字节长，记录该行的唯一标识符，通常用于无主键表中自动生成的聚簇索引。

### 3. **撤销日志（Undo Logs）**
撤销日志分为两类：
- **插入撤销日志**：只用于事务回滚，事务提交后可以丢弃。
- **更新撤销日志**：除了用于回滚操作，还支持一致性读取。更新撤销日志只能在没有事务需要旧版本数据时才会被丢弃。
如果长时间不提交事务，InnoDB 可能无法及时清理更新撤销日志，这可能会导致回滚段变得过大。

### 4. **延迟清理和 Purge**
InnoDB 不会立即物理删除数据行，而是标记为删除，直到相关的撤销日志可以被丢弃。清理过程称为 `purge`，它是一个后台线程，用于定期清理标记为删除的行。如果插入和删除操作频繁但 purge 线程跟不上，可能导致表大小不断增长，性能下降。在这种情况下，可以通过调整 `innodb_max_purge_lag` 来优化 purge 线程的表现。

### 5. **多版本控制与二级索引**
InnoDB 处理二级索引（secondary indexes）与聚簇索引（clustered index）的方式不同：
- 聚簇索引记录会就地更新，并通过隐藏的系统字段追踪旧版本数据。
- 二级索引记录不会就地更新。当更新二级索引时，旧记录会被标记为删除，新记录会被插入，删除标记的记录会在合适的时候被清理。

如果二级索引记录被标记为删除或更新时，InnoDB 会查找聚簇索引中的相应记录，并通过事务 ID 和回滚段来获取该行的正确版本。

### 6. **索引条件下推（ICP）**
如果启用了索引条件下推优化（Index Condition Pushdown，ICP），MySQL 可以在存储引擎层面使用索引字段直接评估 `WHERE` 条件的部分内容，从而避免不必要的聚簇索引查找。但如果在二级索引中找到符合条件的删除标记记录，InnoDB 仍然会查找聚簇索引以获得最新版本的数据。

### 总结
InnoDB 的多版本控制允许多个事务并发访问和修改同一行数据，同时保持事务的隔离性和一致性。通过回滚段、撤销日志以及隐藏的系统字段，InnoDB 实现了事务回滚和一致性读取。同时，通过对聚簇索引和二级索引的不同处理，以及 `purge` 机制，InnoDB 高效地管理了数据库的数据版本和磁盘空间的使用。